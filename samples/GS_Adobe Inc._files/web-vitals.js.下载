async function initiateWebVitalsObservers() {
    const pageLoadId = await createPageLoadId();

    new PerformanceObserver((entryList) => {
        let TTFB = 0;
        const [pageNav] = entryList.getEntriesByType("navigation");
        TTFB = pageNav.responseStart;
        sendBrowserMetricToPanama({ name: "TTFB", value: TTFB });
    }).observe({
        type: "navigation",
        buffered: true,
    });

    new PerformanceObserver((entryList) => {
        let FCP = 0;
        for (const entry of entryList.getEntriesByName("first-contentful-paint")) {
            FCP = entry.startTime;
        }
        sendBrowserMetricToPanama({ name: "FCP", value: FCP });
    }).observe({
        type: "paint",
        buffered: true,
    });

    new PerformanceObserver((entryList) => {
        let CLS = 0;
        for (const entry of entryList.getEntries()) {
            if (!entry.hadRecentInput) {
                CLS += entry.value;
            }
        }
        sendBrowserMetricToPanama({ name: "CLS", value: CLS });
    }).observe({ type: "layout-shift", buffered: true });

    new PerformanceObserver((entryList) => {
        let LCP = 0;
        for (const entry of entryList.getEntries()) {
            if (LCP < entry.startTime) {
                LCP = entry.startTime;
            }
        }
        sendBrowserMetricToPanama({ name: "LCP", value: LCP });
    }).observe({
        type: "largest-contentful-paint",
        buffered: true,
    });

    // This logic is needed to not capture FID if tab is opened in background since FID is not meaningful in that scenario
    var hiddenTime = document.visibilityState === "hidden" ? 0 : Infinity;

    document.addEventListener(
        "visibilitychange",
        (event) => {
            hiddenTime = Math.min(hiddenTime, event.timeStamp);
        },
        { once: true }
    );

    new PerformanceObserver((entryList) => {
        const entry = entryList.getEntries()[0];
        if (entry.startTime < hiddenTime) {
            sendBrowserMetricToPanama({
                name: "FID",
                value: entry.processingStart - entry.startTime,
            });
        }
    }).observe({ type: "first-input", buffered: true });

    document.addEventListener("DOMContentLoaded", () => {
        const DCL = performance.now();
        sendBrowserMetricToPanama({ name: "DCL", value: DCL });
    });

    window.addEventListener("load", () => {
        const DC = performance.now();
        sendBrowserMetricToPanama({ name: "DC", value: DC });
    });

    function sendBrowserMetricToPanama({ name, value }) {
        console.log({ name, value });
        sendEventToPanama(
            {
                Trace: {
                    PageLoadId: pageLoadId,
                },
                MetricName: name,
                MetricValue: value,
            },
            "PortalBrowserMetric"
        );
    }
}

initiateWebVitalsObservers();
