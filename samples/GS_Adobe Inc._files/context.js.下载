const CLIENT_STORAGE_REFRESH_INTERVAL = 300000; // 5 minutes in ms
const LAST_REFRESHED_KEY = "context_last_refreshed";
const CLIENT_PROFILE_KEY = "client-profile";

var getAccessToken = async () => {
    return await window.JwtService?.getJwt();
};

/**
 * Checks if the profile is stale based on the last updated timestamp.
 * @param {string} lastUpdatedTimestamp - The last updated timestamp.
 * @returns {boolean} True if the profile is stale, false otherwise.
 */
const isProfileStale = (lastUpdatedTimestamp) => {
    const now = new Date().getTime();
    return !lastUpdatedTimestamp || now - parseInt(lastUpdatedTimestamp, 10) > CLIENT_STORAGE_REFRESH_INTERVAL;
};

/**
 * Fetches the client profile from the server.
 * @param {string} accessToken - The access token.
 * @returns {Promise<Object>} The client profile data.
 * @throws Will throw an error if the fetch request fails.
 */
const fetchClientProfile = async (accessToken) => {
    const response = await fetch("/research/user", {
        credentials: "include",
        headers: {
            ...(accessToken && { Authorization: `Bearer ${accessToken}` }),
        },
    });

    if (!response.ok) {
        throw new Error("Failed to fetch client profile");
    }

    return await response.json();
};

/**
 * Updates the local storage with the client profile data and updates last refreshed time to current timestamp.
 * @param {Object} data - The client profile data.
 */
const updateLocalStorage = (data) => {
    localStorage.setItem(CLIENT_PROFILE_KEY, JSON.stringify(data));
    localStorage.setItem(LAST_REFRESHED_KEY, new Date().getTime().toString());
    window.dispatchEvent(new CustomEvent("clientProfileUpdated", {}));
};

/**
 * Fetches and updates the client profile data.
 * @returns {Promise<Object>} The client profile data.
 * @throws Will log an error message if the fetch request fails.
 */
const fetchAndUpdateClientProfile = async () => {
    const accessToken = await getAccessToken();
    const data = await fetchClientProfile(accessToken);
    updateLocalStorage(data);
    return data;
};

/**
 * Updates the client profile by fetching the latest data from the server and storing it in local storage.
 * This function is used when a user updates their hasMQExp attribute via another page not hosted by Forge.
 * The page sets a cookie, which is read to update the client profile and reflect the latest status.
 *
 * @returns {Promise<void>} A promise that resolves when the client profile is updated.
 * @throws Will log an error message if the fetch request fails.
 */
const updateClientProfileStore = async () => {
    try {
        await fetchAndUpdateClientProfile();
    } catch (error) {
        console.error(`Failed to update client profile data: ${error.message}`);
    }
};

/**
 * Retrieves the client profile, either from local storage or by fetching it from the server.
 * @returns {Promise<Object>} The client profile data.
 */
const getOrFetchClientProfile = async () => {
    try {
        const lastUpdatedTimestamp = localStorage.getItem(LAST_REFRESHED_KEY);
        const clientProfile = localStorage.getItem(CLIENT_PROFILE_KEY);

        if (!clientProfile || isProfileStale(lastUpdatedTimestamp)) {
            return await fetchAndUpdateClientProfile();
        } else {
            return JSON.parse(clientProfile);
        }
    } catch (error) {
        console.error(`Failed to get client profile data: ${error.message}`);
    }
};

// Try to refresh profile on page load by fetching it from local storage if it exists and is not stale, otherwise fetch from the server
getOrFetchClientProfile();

window.updateClientProfile = updateClientProfileStore;
window.getClientProfile = getOrFetchClientProfile;
