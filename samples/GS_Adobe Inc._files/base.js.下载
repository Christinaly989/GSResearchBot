/* eslint-disable @typescript-eslint/no-unused-vars */

const panamaEndpointPath = "/research/services/lighthouse";

var getAccessToken = async () => {
    return await window.JwtService?.getJwt();
};
const sendEventToPanama = async (data, event_type) => {
    const accessToken = await getAccessToken();

    const eventData = {
        EventType: event_type,
        EventData: data,
    };

    fetch(panamaEndpointPath, {
        credentials: "include",
        method: "POST",
        keepalive: true,
        body: JSON.stringify(eventData),
        headers: {
            "Content-Type": "application/json",
            ...(accessToken && { Authorization: `Bearer ${accessToken}` }),
        },
    });
};

const getPanamaScope = () => {
    const cookies = Object.fromEntries(document.cookie.split(";").map((c) => c.trim().split("=")));
    return cookies?.panama_scope_id
        ? {
              scopeId: cookies?.panama_scope_id,
              isNewScope: !cookies?.panama_scope_started || cookies?.panama_scope_id !== cookies?.panama_scope_started,
          }
        : null;
};

const createPageLoadId = async () => {
    const rawData = performance.timeOrigin + location.origin + location.pathname;
    const data = new TextEncoder().encode(rawData);
    if (!crypto.subtle) {
        return rawData;
    }
    const digestBuffer = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(digestBuffer))
        .map((b) => b.toString(16).padStart(2, "0"))
        .join("");
};
